# CircleCI configuration file
version: 2.1
orbs:
  aws-cli: circleci/aws-cli@4.1.1
  kubernetes: circleci/kubernetes@1.3.1

commands:
  destroy-environment:
    description: Destroy back-end and front-end cloudformation stacks given a workflow ID.
    parameters:
      workflow_id:
        type: string    
    steps:
      - run:
          name: Destroy environments
          when: on_fail
          command: |
            echo "Destroying environment: << parameters.workflow_id >> "
            aws cloudformation delete-stack --stack-name InitialStack
        
jobs:
  validate:
    docker:
     - image: python:3.7.3-stretch
    working_directory: ~/repo
    steps:
      - checkout
      - restore_cache:
          keys:
          - v1-dependencies-{{ checksum "requirements.txt" }}
          # fallback to using the latest cache if no exact match is found
          - v1-dependencies-
      - run:
          name: install dependencies
          command: |
            python3 -m venv venv
            . venv/bin/activate
            echo "done"
            make install
            echo "done"
            # Install hadolint
            wget -O /bin/hadolint https://github.com/hadolint/hadolint/releases/download/v1.16.3/hadolint-Linux-x86_64 &&\
            chmod +x /bin/hadolint
            echo "done"
      - save_cache:
          paths:
            - ./venv
          key: v1-dependencies-{{ checksum "requirements.txt" }}
      - run:
          name: run lint
          command: |
            . venv/bin/activate
            echo "done"
            make lint 
            echo "done"
  build_and_push:
    docker:
      - image: cimg/python:3.7.16
    steps:
      - checkout
      - restore_cache:
          keys:
          - v1-dependencies-{{ checksum "requirements.txt" }}
          # fallback to using the latest cache if no exact match is found
          - v1-dependencies-
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: build-and-push-image
          command: |
            python3 -m venv venv
            . venv/bin/activate
            ./run_docker.sh
            ./upload_docker.sh
      - save_cache:
          paths:
            - ./venv
          key: v1-dependencies-{{ checksum "requirements.txt" }}

  # deploy-infrastructure:
  #   docker:
  #     - image: amazon/aws-cli
  #   steps:
  #     - checkout
  #     - run:
  #         name: Install gzip
  #         command: |
  #           yum -y install tar gzip
  #     - run:
  #         name: Ensure cluster infrastructure exists
  #         command: |
  #           aws cloudformation deploy \
  #             --template-file .circleci/files/kubernetes-cluster.yml \
  #             --stack-name "udapeople-cluster-${CIRCLE_WORKFLOW_ID:0:7}" \
  #             --parameter-overrides ID="${CIRCLE_WORKFLOW_ID:0:7}" \
  #             --tags project=udapeople
  #     - destroy-environment:
  #           workflow_id: "${CIRCLE_WORKFLOW_ID:0:7}"
  deploy_infra:
    docker:
      - image: cimg/python:3.7.16
    steps:
      - checkout
      - aws-cli/setup:
          profile_name: "default"
      - kubernetes/install
      - restore_cache:
          keys:
          - v1-dependencies-{{ checksum "requirements.txt" }}
          # fallback to using the latest cache if no exact match is found
          - v1-dependencies-
      - run:
          name: deploy_apps
          command: |
            # aws eks create-cluster --region us-east-1 --name my-cluster3 --kubernetes-version 1.28 \
            # --role-arn arn:aws:iam::837117057604:role/myAmazonEKSClusterRole \
            # --resources-vpc-config subnetIds=subnet-04c3a7789e530823a,subnet-026079be198c13213,subnet-0295f0553ea92cb97
              aws cloudformation deploy \
              --template-file .circleci/files/kubernetes-cluster.yml \
              --stack-name InitialStack \
              --parameter-overrides WorkflowID="${CIRCLE_WORKFLOW_ID:0:7}" \
              --tags project=udapeople
      - save_cache:
          paths:
            - ./venv
          key: v1-dependencies-{{ checksum "requirements.txt" }}
      - destroy-environment:
            workflow_id: "${CIRCLE_WORKFLOW_ID:0:7}"
  configure:
    docker:
      - image: cimg/python:3.7.16
    steps:
      - checkout
      - aws-cli/setup:
          profile_name: "default"
      - kubernetes/install
      - restore_cache:
          keys:
          - v1-dependencies-{{ checksum "requirements.txt" }}
          # fallback to using the latest cache if no exact match is found
          - v1-dependencies-
      - run:
          name: deploy_apps
          command: |
            aws eks update-kubeconfig --region us-east-1 --name my-cluster
            kubectl get svc
      - save_cache:
          paths:
            - ./venv
          key: v1-dependencies-{{ checksum "requirements.txt" }}
      - destroy-environment:
            workflow_id: "${CIRCLE_WORKFLOW_ID:0:7}"
workflows:
  capstone:
    jobs:
      #- validate
     # - build_and_push
      - deploy_infra
            #requires: [build_and_push]
      - configure:
            requires: [deploy_infra]